<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Potree Viewer</title>

  <!-- Deine vorhandenen Potree-Libs -->
  <link rel="stylesheet" type="text/css" href="./libs/potree/potree.css">
  <link rel="stylesheet" type="text/css" href="./libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css">
  <link rel="stylesheet" type="text/css" href="./libs/spectrum/spectrum.css">
  <link rel="stylesheet" type="text/css" href="./libs/jstree/themes/mixed/style.css">

  <style>
    html, body { height: 100%; margin: 0 }
    .potree_container { position: absolute; inset: 0 }
    #potree_render_area { background: #f8f9fb }
    #ui {
      position: absolute; top: 12px; right: 12px; z-index: 1000;
      background: #fff; padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15); font-family: sans-serif; line-height: 1.4
    }
    #ui button { margin: 2px 3px }
    #legend { margin-top: 10px; font-size: 12px; color: #333; min-height: 1.2em }
    #hwrap { display: flex; align-items: center; gap: 8px; margin-top: 6px }
    #hwrap label { font-size: 12px; color: #333 }
    button[disabled]{ opacity: .4; cursor: not-allowed }
  </style>
</head>

<body>
  <!-- JS-Libs -->
  <script src="./libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="./libs/spectrum/spectrum.js"></script>
  <script src="./libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="./libs/other/BinaryHeap.js"></script>
  <script src="./libs/tween/tween.min.js"></script>
  <script src="./libs/d3/d3.js"></script>
  <script src="./libs/proj4/proj4.js"></script>
  <script src="./libs/openlayers3/ol.js"></script>
  <script src="./libs/i18next/i18next.js"></script>
  <script src="./libs/jstree/jstree.js"></script>
  <script src="./libs/potree/potree.js"></script>
  <script src="./libs/plasio/js/laslaz.js"></script>

  <!-- Potree: Canvas + Sidebar -->
  <div class="potree_container">
    <div id="potree_render_area"></div>
    <div id="potree_sidebar_container"></div>

    <!-- UI-Overlay -->
    <div id="ui">
      <div><b>Color</b></div>
      <div>
        <button id="btnRGB" onclick="setColor('rgb')">RGB</button>
        <button onclick="setColor('elevation', rel(3.0))">H 0–3 m</button>
        <button onclick="setColor('elevation', rel(5.0))">H 0–5 m</button>
        <button onclick="setColor('elevation', band(3.0,5.0))">Band 3–5 m</button>
        <button id="btnIntensity" onclick="setColor('intensity')">Intensity</button>
        <button id="btnClass" onclick="setColor('classification')">Class</button>
      </div>

      <div id="hwrap">
        <label for="hmin">Min über Ground</label>
        <input id="hmin" type="number" step="0.1" value="0.0" style="width:80px" oninput="applyElev()">
        <label for="hmax">Max über Ground</label>
        <input id="hmax" type="number" step="0.1" value="5.0" style="width:80px" oninput="applyElev()">
      </div>

      <div style="margin-top:6px"><b>Ground</b></div>
      <div>
        <button onclick="setGround(true)">Show</button>
        <button onclick="setGround(false)">Hide</button>
      </div>

      <div id="legend"></div>
    </div>
  </div>

  <script>
    // Pfade und konstante Ground-Höhe
    const METADATA_URL = "./metadata.json";
    const Z0 = -44.6;  // Ground bei −44.6 m (absolut)

    // Attribute-Flags
    let hasRGB = false, hasIntensity = false, hasClassification = false;

    // Viewer
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
    viewer.setEDLEnabled(true);
    viewer.setFOV(60);
    viewer.setPointBudget(2_000_000);
    viewer.setDescription("");
    // Optional deaktiviert, damit keine URL-Parameter Einstellungen überschreiben:
    // viewer.loadSettingsFromURL();

    viewer.loadGUI(() => {
      viewer.setLanguage('en');
      $("#menu_appearance").next().show();
      $("#menu_tools").next().show();
      $("#menu_clipping").next().show();
      viewer.toggleSidebar();

        // Force closed (works across Potree builds)
  if (viewer.setSidebarVisible) {
    viewer.setSidebarVisible(false);
  } else {
    const sc = document.getElementById('potree_sidebar_container');
    if (sc) sc.style.display = 'none';
  }
    });

    // Helfer
    function rerender(){ if (typeof viewer.render === 'function') viewer.render(); }
    function legend(txt){ const el = document.getElementById('legend'); if (el) el.textContent = txt; }

    // Bereiche relativ zu Ground
    function rel(spanMeters, offsetMeters=0){
      const minAbs = Z0 + offsetMeters;
      const maxAbs = Z0 + offsetMeters + spanMeters;
      return [minAbs, maxAbs];
    }
    function band(minOver, maxOver){
      return [Z0 + minOver, Z0 + maxOver];
    }

    // Cloud laden
    Potree.loadPointCloud(METADATA_URL, "Mangroves").then(async e => {
      window.pc = e.pointcloud;
      viewer.scene.addPointCloud(pc);
      viewer.fitToScreen();

      // Klassen sichtbar machen
      const cls = pc.material.classification || {};
      for (let i = 0; i < 256; i++) {
        if (!cls[i]) cls[i] = { visible: true, name: `c${i}`, color: new THREE.Color(0.7,0.7,0.7) };
        else cls[i].visible = true;
      }
      if (cls[0]) cls[0].color = new THREE.Color(0.70,0.70,0.70);
      if (cls[1]) cls[1].color = new THREE.Color(0.45,0.45,0.45);
      if (cls[2]) cls[2].color = new THREE.Color(0.55,0.40,0.28);
      pc.material.classification = cls;

      // Verfügbare Attribute prüfen
      try {
        const meta = await fetch(METADATA_URL).then(r => r.json());
        const attrs = (meta.attributes || []).map(a => {
          if (typeof a === 'string') return a.toLowerCase();
          if (a && a.name) return String(a.name).toLowerCase();
          return '';
        });
        hasRGB            = attrs.some(a => a.includes('rgb') || a.includes('color'));
        hasIntensity      = attrs.some(a => a.includes('intensity'));
        hasClassification = attrs.some(a => a.includes('classification'));
        if (!hasRGB) document.getElementById('btnRGB').disabled = true;
        if (!hasIntensity) document.getElementById('btnIntensity').disabled = true;
        if (!hasClassification) document.getElementById('btnClass').disabled = true;
      } catch(_) {}

      // Darstellung
      if (pc.material.pointSizeType && Potree.PointSizeType) {
        pc.material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
      }
      pc.material.size = 2.0;

      // Default: 0–5 m über Ground und Ground ausblenden
      setColor('elevation', rel(5.0));
      setGround(false);

      // UI Felder synchronisieren
      document.getElementById('hmin').value = 0.0;
      document.getElementById('hmax').value = 5.0;
    });

    // Farbwechsel (kompatibel mit alten/neueren Potree-APIs)
    function setColor(mode, range){
      if (!window.pc) return;

      const useEnums = ('pointColorType' in pc.material) && Potree.PointColorType;
      const setEnum  = t => pc.material.pointColorType = t;
      const setAttr  = n => pc.material.activeAttributeName = n;

      if (mode === 'rgb' && !hasRGB){ setColor('elevation', rel(5.0)); legend('RGB fehlt → Elevation 0–5 m'); return; }
      if (mode === 'intensity' && !hasIntensity){ setColor('elevation', rel(5.0)); legend('Intensity fehlt → Elevation 0–5 m'); return; }
      if (mode === 'classification' && !hasClassification){ setColor('elevation', rel(5.0)); legend('Classification fehlt → Elevation 0–5 m'); return; }

      if (mode === 'rgb'){
        if (useEnums) setEnum(Potree.PointColorType.RGB); else setAttr('rgb');
        legend('RGB');
      }

      if (mode === 'elevation'){
        if (useEnums) setEnum(Potree.PointColorType.ELEVATION); else setAttr('elevation');
        const r = range || rel(5.0);
        pc.material.elevationRange = r;
        if (Potree.Gradients && Potree.Gradients.Viridis) pc.material.gradient = Potree.Gradients.Viridis;
        legend(`Elevation: ${r[0].toFixed(2)} – ${r[1].toFixed(2)} m`);
        // UI synchronisieren, als Werte „über Ground“
        const minOver = (r[0] - Z0);
        const maxOver = (r[1] - Z0);
        const minEl = document.getElementById('hmin');
        const maxEl = document.getElementById('hmax');
        if (minEl) minEl.value = +minOver.toFixed(2);
        if (maxEl) maxEl.value = +maxOver.toFixed(2);
      }

      if (mode === 'intensity'){
        if (useEnums) setEnum(Potree.PointColorType.INTENSITY); else setAttr('intensity');
        pc.material.intensityRange = [0, 300];
        legend('Intensity 0–300');
      }

      if (mode === 'classification'){
        if (useEnums) setEnum(Potree.PointColorType.CLASSIFICATION); else setAttr('classification');
        legend('Classification');
      }

      pc.material.needsUpdate = true;
      rerender();
    }

    // Manuelle Feinjustierung über UI-Felder (Werte werden als „über Ground“ interpretiert)
    function applyElev(){
      if (!window.pc) return;
      const overMin = parseFloat(document.getElementById('hmin').value);
      const overMax = parseFloat(document.getElementById('hmax').value);
      if (!isFinite(overMin) || !isFinite(overMax) || overMax <= overMin) return;
      const r = band(overMin, overMax);
      setColor('elevation', r);
    }

    // Ground ein/aus
    function setGround(show){
      if (!window.pc) return;
      const cls = pc.material.classification || {};
      [0,1,2].forEach(id => { cls[id] = cls[id] || { visible:true, color:new THREE.Color(0.7,0.7,0.7) }; });
      cls[2].visible = !!show; // 2 = ground
      pc.material.classification = cls;
      pc.material.needsUpdate = true;
      rerender();
    }
  </script>
</body>
</html>
